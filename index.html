<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="color-scheme" content="dark light" />
  <title>MemeSwipe WebApp</title>

  <style>
    :root{
      --bg: #0b0f19;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --muted2: rgba(255,255,255,.45);
      --stroke: rgba(255,255,255,.12);
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --shadow2: 0 10px 30px rgba(0,0,0,.35);
      --radius: 22px;

      --like: #2ee59d;
      --dislike: #ff4d6d;
      --warn: #ffcc00;

      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 20% -10%, rgba(73,117,255,.18), transparent 55%),
                  radial-gradient(900px 600px at 110% 10%, rgba(46,229,157,.12), transparent 60%),
                  radial-gradient(900px 600px at 80% 120%, rgba(255,77,109,.10), transparent 55%),
                  var(--bg);
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      overflow:hidden;
    }

    /* Telegram fit */
    .app{
      height: 100%;
      width: 100%;
      display:flex;
      flex-direction:column;
      padding-top: calc(var(--safe-top) + 10px);
      padding-bottom: calc(var(--safe-bottom) + 10px);
    }

    /* Top bar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 14px 8px;
      gap: 10px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      user-select:none;
    }
    .logo{
      width: 34px; height:34px;
      border-radius: 12px;
      background:
        radial-gradient(18px 18px at 30% 35%, rgba(255,255,255,.28), transparent 60%),
        linear-gradient(135deg, rgba(73,117,255,.85), rgba(46,229,157,.85));
      box-shadow: var(--shadow2);
      position:relative;
      overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute; inset:-40%;
      background: linear-gradient(120deg, transparent 35%, rgba(255,255,255,.20) 45%, transparent 55%);
      transform: rotate(18deg);
      animation: shine 6s linear infinite;
    }
    @keyframes shine{
      0%{ transform: translateX(-40%) rotate(18deg); opacity:.0; }
      12%{ opacity:.7; }
      30%{ transform: translateX(60%) rotate(18deg); opacity:0; }
      100%{ transform: translateX(60%) rotate(18deg); opacity:0; }
    }
    .brand .title{
      font-weight: 800;
      letter-spacing: .2px;
      line-height: 1.05;
    }
    .brand .subtitle{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
    }
    .pill{
      display:flex; align-items:center; gap:8px;
      padding: 8px 10px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.04);
      border-radius: 999px;
      box-shadow: 0 6px 18px rgba(0,0,0,.22);
      user-select:none;
      cursor: default;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: var(--like);
      box-shadow: 0 0 0 5px rgba(46,229,157,.12);
    }
    .pill small{ color: var(--muted); }

    /* Stage */
    .stage{
      flex:1;
      padding: 8px 14px 0;
      display:flex;
      align-items:stretch;
      justify-content:center;
      position:relative;
      min-height: 0;
    }

    .cardWrap{
      width: min(520px, 100%);
      position:relative;
      flex:1;
      min-height: 0;
      display:flex;
      align-items:stretch;
      justify-content:center;
    }

    .memeCard{
      width: 100%;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:absolute;
      inset: 0;
      display:flex;
      flex-direction:column;
      transform: translate3d(0,0,0);
      will-change: transform;
      touch-action: pan-y; /* allow vertical scroll if needed, we handle horizontal */
    }

    .memeMedia{
      flex: 1;
      min-height: 0;
      position:relative;
      background: rgba(255,255,255,.03);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }

    /* image */
    .memeMedia img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scale(1.02);
      filter: saturate(1.06) contrast(1.02);
      user-select:none;
      -webkit-user-drag:none;
    }

    /* top overlay */
    .memeTop{
      position:absolute;
      left: 12px; right: 12px; top: 12px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 10px;
      pointer-events:none;
    }
    .authorBox{
      pointer-events:none;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      max-width: 70%;
    }
    .author{
      font-weight: 750;
      letter-spacing: .2px;
      font-size: 14px;
      line-height:1.2;
      display:flex; align-items:center; gap:8px;
    }
    .author .badge{
      font-size: 11px;
      color: rgba(255,255,255,.70);
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
    }
    .meta{
      margin-top: 4px;
      font-size: 12px;
      color: rgba(255,255,255,.70);
      display:flex; gap:10px; flex-wrap:wrap;
    }

    .scoreBox{
      pointer-events:none;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(0,0,0,.28);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
      text-align:right;
      min-width: 96px;
    }
    .score{
      font-weight: 900;
      font-size: 16px;
      letter-spacing: .2px;
    }
    .score small{ font-weight: 650; color: rgba(255,255,255,.70); }

    /* bottom caption */
    .caption{
      padding: 12px 14px;
      border-top: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 12px;
    }
    .caption .text{
      min-width:0;
    }
    .caption .text .line1{
      font-weight: 760;
      font-size: 14px;
      line-height: 1.2;
      margin-bottom: 2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .caption .text .line2{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .hint{
      display:flex;
      align-items:center;
      gap:8px;
      color: rgba(255,255,255,.70);
      font-size: 12px;
      user-select:none;
      white-space:nowrap;
    }
    .hint .chip{
      width: 8px; height: 8px; border-radius: 999px;
      background: rgba(255,255,255,.45);
    }

    /* Swipe feedback overlays */
    .stamp{
      position:absolute;
      top: 20px;
      padding: 10px 14px;
      border-radius: 16px;
      border: 2px solid;
      font-weight: 900;
      letter-spacing: .8px;
      font-size: 14px;
      text-transform: uppercase;
      transform: rotate(-10deg) scale(.96);
      opacity: 0;
      transition: opacity .12s ease, transform .12s ease;
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
      pointer-events:none;
    }
    .stamp.like{
      left: 18px;
      color: var(--like);
      border-color: rgba(46,229,157,.85);
      box-shadow: 0 0 0 10px rgba(46,229,157,.08);
    }
    .stamp.dislike{
      right: 18px;
      color: var(--dislike);
      border-color: rgba(255,77,109,.85);
      box-shadow: 0 0 0 10px rgba(255,77,109,.08);
      transform: rotate(10deg) scale(.96);
    }
    .stamp.on{
      opacity: 1;
      transform: rotate(-10deg) scale(1.02);
    }
    .stamp.dislike.on{
      transform: rotate(10deg) scale(1.02);
    }

    /* Bottom profile bubble (semi-circle dock) */
    .dock{
      position: relative;
      width: 100%;
      display:flex;
      justify-content:center;
      padding: 10px 14px 0;
      pointer-events:none; /* allow only inside */
    }

    .dockInner{
      width: min(520px, 100%);
      position:relative;
      height: 84px;
      pointer-events:none;
    }

    .bubble{
      pointer-events:auto;
      position:absolute;
      left: 50%;
      bottom: 0;
      transform: translateX(-50%);
      width: 76px;
      height: 76px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.26), transparent 60%),
                  linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow2);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: transform .18s ease, filter .18s ease;
    }
    .bubble:active{ transform: translateX(-50%) scale(.97); }
    .avatar{
      width: 58px; height: 58px;
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 10px 20px rgba(0,0,0,.25);
      background: linear-gradient(135deg, rgba(73,117,255,.65), rgba(46,229,157,.55));
      display:flex; align-items:center; justify-content:center;
      font-weight: 900;
      letter-spacing:.4px;
      user-select:none;
    }

    /* semi-circle plate */
    .plate{
      pointer-events:none;
      position:absolute;
      left: 50%;
      bottom: -38px;
      transform: translateX(-50%);
      width: 180px;
      height: 120px;
      border-radius: 120px 120px 28px 28px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      backdrop-filter: blur(10px);
      box-shadow: 0 12px 28px rgba(0,0,0,.25);
    }

    /* Sheets */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(8px);
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index: 50;
    }
    .overlay.on{
      opacity: 1;
      pointer-events:auto;
    }

    .sheet{
      position: fixed;
      left: 0; right: 0;
      bottom: -100%;
      z-index: 60;
      transition: bottom .26s cubic-bezier(.2,.85,.2,1);
      padding: 10px 12px calc(var(--safe-bottom) + 12px);
    }
    .sheet.on{ bottom: 0; }

    .panel{
      width: min(560px, 100%);
      margin: 0 auto;
      border-radius: 26px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .grab{
      display:flex; justify-content:center;
      padding: 10px 0 0;
    }
    .grab .bar{
      width: 44px; height: 5px;
      border-radius: 999px;
      background: rgba(255,255,255,.25);
    }

    .panelHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 12px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .panelHeader .h{
      font-weight: 900;
      letter-spacing: .2px;
    }
    .xbtn{
      width: 38px; height: 38px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      backdrop-filter: blur(10px);
      color: rgba(255,255,255,.88);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease;
    }
    .xbtn:active{ transform: scale(.96); }

    .panelBody{
      padding: 12px 14px 14px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 10px;
    }
    .statCard{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      border-radius: 18px;
      padding: 12px 12px;
    }
    .statCard .k{ color: var(--muted); font-size:12px; }
    .statCard .v{ font-weight: 900; font-size: 18px; margin-top:2px; }

    .profileRow{
      display:flex; align-items:center; gap:12px;
      padding: 8px 0 12px;
    }
    .profileRow .pAvatar{
      width: 54px; height:54px; border-radius:999px;
      background: linear-gradient(135deg, rgba(73,117,255,.65), rgba(46,229,157,.55));
      border: 1px solid rgba(255,255,255,.16);
      display:flex; align-items:center; justify-content:center;
      font-weight: 900;
    }
    .profileRow .name{
      font-weight: 900; letter-spacing:.2px;
    }
    .profileRow .lvl{
      margin-top:2px;
      font-size:12px; color: var(--muted);
    }

    .btnRow{ display:flex; gap:10px; padding-top: 10px; }
    .btn{
      flex:1;
      padding: 12px 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.90);
      font-weight: 800;
      letter-spacing: .2px;
      cursor:pointer;
      user-select:none;
      text-align:center;
      transition: transform .12s ease, filter .12s ease;
    }
    .btn:active{ transform: scale(.98); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(73,117,255,.70), rgba(46,229,157,.55));
      border-color: rgba(255,255,255,.18);
    }
    .btn.danger{
      background: rgba(255,77,109,.12);
      border-color: rgba(255,77,109,.25);
    }

    /* Report sheet list */
    .reasonList{
      display:flex;
      flex-direction:column;
      gap: 8px;
      padding-top: 6px;
    }
    .reason{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      padding: 12px 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .reason:active{ transform: scale(.99); }
    .reason .l{
      font-weight: 800;
      letter-spacing: .2px;
    }
    .reason .r{
      font-size: 12px;
      color: var(--muted);
    }
    .reason.sel{
      border-color: rgba(255,204,0,.55);
      background: rgba(255,204,0,.10);
    }

    /* Rating screen (full) */
    .screen{
      position: fixed;
      inset: 0;
      z-index: 80;
      transform: translateY(12px);
      opacity: 0;
      pointer-events:none;
      transition: opacity .16s ease, transform .16s ease;
      padding-top: calc(var(--safe-top) + 10px);
      padding-bottom: calc(var(--safe-bottom) + 12px);
      overflow:hidden;
    }
    .screen.on{
      opacity: 1;
      pointer-events:auto;
      transform: translateY(0);
    }
    .screen .wrap{
      height:100%;
      width: min(560px, 100%);
      margin: 0 auto;
      padding: 0 14px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .screenTop{
      display:flex; align-items:center; justify-content:space-between;
      padding: 8px 0 2px;
    }
    .screenTop .t{
      font-weight: 900;
      letter-spacing:.2px;
      font-size: 18px;
    }
    .tabs{
      display:flex; gap:8px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      padding: 6px;
      width: fit-content;
    }
    .tab{
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 850;
      font-size: 12px;
      color: rgba(255,255,255,.75);
      cursor:pointer;
      user-select:none;
      border:1px solid transparent;
      transition: background .12s ease, color .12s ease;
      white-space:nowrap;
    }
    .tab.on{
      background: rgba(255,255,255,.12);
      color: rgba(255,255,255,.92);
      border-color: rgba(255,255,255,.14);
    }

    .filters{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }

    .list{
      flex:1;
      min-height:0;
      overflow:auto;
      padding-bottom: 6px;
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,.18) transparent;
    }
    .row{
      display:flex;
      gap: 10px;
      padding: 10px 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      border-radius: 18px;
      margin-bottom: 10px;
      align-items:center;
    }
    .thumb{
      width: 54px; height:54px;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      flex:0 0 auto;
      background: rgba(255,255,255,.06);
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; }
    .row .info{
      min-width:0;
      flex:1;
    }
    .row .info .main{
      font-weight: 900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .row .info .sub{
      margin-top:2px;
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .row .rank{
      flex:0 0 auto;
      font-weight: 950;
      color: rgba(255,255,255,.85);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 8px 10px;
      text-align:right;
      min-width: 74px;
    }
    .row .rank .s{
      display:block; font-size: 11px; color: var(--muted);
      font-weight: 800;
      margin-top:2px;
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(var(--safe-bottom) + 96px);
      transform: translateX(-50%) translateY(10px);
      z-index: 90;
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.30);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow2);
      font-weight: 850;
      color: rgba(255,255,255,.92);
      max-width: min(520px, 92vw);
      text-align:center;
    }
    .toast.on{
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; }
    }
  </style>
</head>

<body>
  <div class="app" id="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          <div class="title">MemeSwipe</div>
          <div class="subtitle">—Å–≤–∞–π–ø–∞–π –º–µ–º—ã, –∫–∞—á–∞–π —É—Ä–æ–≤–µ–Ω—å</div>
        </div>
      </div>
      <div class="pill" id="pill">
        <div class="dot"></div>
        <div>
          <div style="font-weight:900; letter-spacing:.2px" id="pillText">Online</div>
          <small id="pillSub">WebApp</small>
        </div>
      </div>
    </div>

    <div class="stage">
      <div class="cardWrap" id="cardWrap">
        <!-- Card inserted via JS -->
      </div>
    </div>

    <div class="dock">
      <div class="dockInner">
        <div class="plate"></div>
        <div class="bubble" id="profileBubble" aria-label="–ü—Ä–æ—Ñ–∏–ª—å">
          <div class="avatar" id="bubbleAvatar">A</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Overlays / Sheets -->
  <div class="overlay" id="overlay"></div>

  <!-- Profile sheet -->
  <div class="sheet" id="profileSheet" aria-hidden="true">
    <div class="panel">
      <div class="grab"><div class="bar"></div></div>
      <div class="panelHeader">
        <div class="h">–ü—Ä–æ—Ñ–∏–ª—å</div>
        <div class="xbtn" id="closeProfile">‚úï</div>
      </div>
      <div class="panelBody">
        <div class="profileRow">
          <div class="pAvatar" id="profileAvatar">A</div>
          <div style="min-width:0">
            <div class="name" id="profileName">Aceton</div>
            <div class="lvl" id="profileLvl">–£—Ä–æ–≤–µ–Ω—å 1 ¬∑ XP 0 ¬∑ –ª–∏–º–∏—Ç: 3/–¥–µ–Ω—å</div>
          </div>
        </div>

        <div class="grid2">
          <div class="statCard">
            <div class="k">–¢–≤–æ–∏ –º–µ–º—ã</div>
            <div class="v" id="statMemes">0</div>
          </div>
          <div class="statCard">
            <div class="k">–û–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥</div>
            <div class="v" id="statScore">0</div>
          </div>
          <div class="statCard">
            <div class="k">–õ–∞–π–∫–∏</div>
            <div class="v" id="statLikes">0</div>
          </div>
          <div class="statCard">
            <div class="k">–î–∏–∑–ª–∞–π–∫–∏</div>
            <div class="v" id="statDislikes">0</div>
          </div>
        </div>

        <div class="btnRow">
          <div class="btn primary" id="btnAddMeme">–î–æ–±–∞–≤–∏—Ç—å –º–µ–º</div>
          <div class="btn" id="btnRating">–†–µ–π—Ç–∏–Ω–≥</div>
        </div>

        <div class="btnRow">
          <div class="btn danger" id="btnResetDemo">–°–±—Ä–æ—Å–∏—Ç—å –¥–µ–º–æ</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Report sheet -->
  <div class="sheet" id="reportSheet" aria-hidden="true">
    <div class="panel">
      <div class="grab"><div class="bar"></div></div>
      <div class="panelHeader">
        <div class="h">–ü–æ–∂–∞–ª–æ–≤–∞—Ç—å—Å—è</div>
        <div class="xbtn" id="closeReport">‚úï</div>
      </div>
      <div class="panelBody">
        <div style="color:var(--muted); font-size:12px; margin-bottom:8px" id="reportTarget">
          –ú–µ–º: ‚Äî
        </div>

        <div class="reasonList" id="reasonList"></div>

        <div class="btnRow" style="margin-top:10px">
          <div class="btn primary" id="sendReport">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</div>
          <div class="btn" id="cancelReport">–û—Ç–º–µ–Ω–∞</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Rating screen -->
  <div class="screen" id="ratingScreen" aria-hidden="true">
    <div class="wrap">
      <div class="screenTop">
        <div class="t">–†–µ–π—Ç–∏–Ω–≥</div>
        <div class="xbtn" id="closeRating">‚úï</div>
      </div>

      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
        <div class="tabs">
          <div class="tab on" id="tabMemes">–¢–æ–ø –º–µ–º–æ–≤</div>
          <div class="tab" id="tabAuthors">–¢–æ–ø –∞–≤—Ç–æ—Ä–æ–≤</div>
        </div>
        <div class="filters tabs" style="padding:6px">
          <div class="tab on" data-range="day">–°–µ–≥–æ–¥–Ω—è</div>
          <div class="tab" data-range="week">–ù–µ–¥–µ–ª—è</div>
          <div class="tab" data-range="all">–í—Å—ë</div>
        </div>
      </div>

      <div class="list" id="ratingList"></div>
    </div>
  </div>

  <div class="toast" id="toast">‚Äî</div>

  <input type="file" id="fileInput" accept="image/*" style="display:none" />

  <script>
    /***********************
     * Telegram WebApp fit *
     ***********************/
    const TG = window.Telegram?.WebApp;
    try{
      TG?.ready();
      TG?.expand();
      // Make Telegram UI look consistent
      TG?.setHeaderColor?.("secondary_bg_color");
      TG?.setBackgroundColor?.("#0b0f19");
      // optional: disable vertical swipe closing
      TG?.enableClosingConfirmation?.();
    }catch(e){}

    /****************
     * Demo content *
     ****************/
    // In production: memes come from backend, images stored in CDN/S3.
    // Here: use reliable placeholder images (picsum). Replace with your storage later.
    const demoMemes = [
      { id: "m1", authorId:"u2", author:"Sasha", title:"–ö–æ–≥–¥–∞ –¥–µ–¥–ª–∞–π–Ω –±—ã–ª –≤—á–µ—Ä–∞", img:"https://picsum.photos/seed/meme101/900/1200", likes: 12, dislikes: 3, reports:0 },
      { id: "m2", authorId:"u3", author:"Olya", title:"–°–¥–∞–ª –ª–∞–±—É‚Ä¶ –Ω–æ –Ω–µ —Ç—É", img:"https://picsum.photos/seed/meme102/900/1200", likes: 4, dislikes: 6, reports:0 },
      { id: "m3", authorId:"u4", author:"Tim", title:"–Ø: –Ω–∞—á–Ω—É —Å –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞", img:"https://picsum.photos/seed/meme103/900/1200", likes: 20, dislikes: 5, reports:0 },
      { id: "m4", authorId:"u5", author:"Nastya", title:"–ö–æ–≥–¥–∞ –ø—Ä–µ–ø–æ–¥ —Å–∫–∞–∑–∞–ª '—ç—Ç–æ –ª–µ–≥–∫–æ'", img:"https://picsum.photos/seed/meme104/900/1200", likes: 8, dislikes: 1, reports:0 },
      { id: "m5", authorId:"u6", author:"Max", title:"–ö–æ–º–º–∏—Ç: fix", img:"https://picsum.photos/seed/meme105/900/1200", likes: 2, dislikes: 9, reports:0 },
      { id: "m6", authorId:"u7", author:"Ira", title:"–Ø –ø–æ—Å–ª–µ 2 —á–∞—Å–æ–≤ —Å–Ω–∞", img:"https://picsum.photos/seed/meme106/900/1200", likes: 15, dislikes: 2, reports:0 },
      { id: "m7", authorId:"u8", author:"Den", title:"–°–µ–º–∏–Ω–∞—Ä ‚Äî —ç—Ç–æ –æ—Ç–¥—ã—Ö", img:"https://picsum.photos/seed/meme107/900/1200", likes: 7, dislikes: 7, reports:0 },
      { id: "m8", authorId:"u9", author:"Vika", title:"–°–ª—É—á–∞–π–Ω–æ —É–¥–∞–ª–∏–ª –ø–∞–ø–∫—É project", img:"https://picsum.photos/seed/meme108/900/1200", likes: 19, dislikes: 4, reports:0 },
    ];

    // Local state (in prod: per-user in DB)
    const state = {
      user: {
        id: "u1",
        name: "Aceton",
        xp: 0,
        level: 1,
        likesReceived: 0,
        dislikesReceived: 0,
        memesPosted: 0,
        score: 0,
        postedToday: 0,
        postedThisHour: 0,
        lastHourKey: hourKeyNow(),
      },
      memes: [],
      seen: new Set(),         // memeIds seen/voted by this user
      hidden: new Set(),       // memeIds hidden (reported)
      queue: [],               // available meme ids for feed (not seen, not hidden)
      current: null,           // current meme object
      lastAuthorId: null,      // to avoid same author twice in a row
      report: {
        openForMemeId: null,
        selectedReason: null,
      },
      rating: {
        mode: "memes", // memes|authors
        range: "day",  // day|week|all (demo only)
      }
    };

    // Clone demo to state
    state.memes = demoMemes.map(m => ({...m}));

    /***********************
     * Level / posting caps *
     ***********************/
    const LEVELS = [
      { level: 1, xpNeed: 0,   perDay: 3,  perHour: 2, title:"–ù–æ–≤–∏—á–æ–∫" },
      { level: 2, xpNeed: 40,  perDay: 5,  perHour: 3, title:"–ú–µ–º–µ—Ä" },
      { level: 3, xpNeed: 120, perDay: 8,  perHour: 4, title:"–ú–µ–º–æ–ª–æ–≥" },
      { level: 4, xpNeed: 260, perDay: 12, perHour: 5, title:"–¢–æ–ø—á–∏–∫" },
      { level: 5, xpNeed: 520, perDay: 20, perHour: 6, title:"–ö–æ—Ä–æ–ª—å –º–µ–º–æ–≤" },
    ];

    function getLevelInfo(xp){
      let cur = LEVELS[0];
      for(const l of LEVELS){
        if(xp >= l.xpNeed) cur = l;
      }
      return cur;
    }

    function hourKeyNow(){
      const d = new Date();
      return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()} ${d.getHours()}`;
    }

    function resetHourIfNeeded(){
      const k = hourKeyNow();
      if(state.user.lastHourKey !== k){
        state.user.lastHourKey = k;
        state.user.postedThisHour = 0;
      }
    }

    /*****************
     * Feed selection *
     *****************/
    function rebuildQueue(){
      // eligible = not seen + not hidden
      const eligible = state.memes.filter(m => !state.seen.has(m.id) && !state.hidden.has(m.id));
      // shuffle
      const shuffled = eligible.map(m => m.id);
      fisherYates(shuffled);

      // avoid same author twice in a row (soft rule)
      if(state.lastAuthorId){
        // try to move first element if same author
        for(let i=0;i<Math.min(6, shuffled.length);i++){
          const mm = state.memes.find(x => x.id === shuffled[i]);
          if(mm && mm.authorId !== state.lastAuthorId){
            // swap to front
            [shuffled[0], shuffled[i]] = [shuffled[i], shuffled[0]];
            break;
          }
        }
      }
      state.queue = shuffled;
    }

    function nextMeme(){
      if(state.queue.length === 0){
        rebuildQueue();
      }
      if(state.queue.length === 0){
        // no more memes
        state.current = null;
        renderEmpty();
        return;
      }
      // pick next that doesn't violate author rule if possible
      let id = state.queue.shift();
      let m = state.memes.find(x => x.id === id);

      if(state.lastAuthorId && m && m.authorId === state.lastAuthorId){
        // try find alternative within first few
        let swapIdx = -1;
        for(let i=0;i<Math.min(8, state.queue.length);i++){
          const mm = state.memes.find(x => x.id === state.queue[i]);
          if(mm && mm.authorId !== state.lastAuthorId){
            swapIdx = i;
            break;
          }
        }
        if(swapIdx >= 0){
          state.queue.unshift(id); // put back
          id = state.queue.splice(swapIdx+1, 1)[0] ?? id; // careful
          // above line can misbehave; do safe:
          const alt = state.queue.splice(swapIdx, 1)[0];
          state.queue.unshift(id);
          id = alt;
          m = state.memes.find(x => x.id === id);
        }
      }

      state.current = m;
      renderCard(m);
    }

    function fisherYates(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    /****************
     * UI Rendering *
     ****************/
    const cardWrap = document.getElementById("cardWrap");
    const bubbleAvatar = document.getElementById("bubbleAvatar");
    const profileAvatar = document.getElementById("profileAvatar");
    const profileName = document.getElementById("profileName");
    const profileLvl = document.getElementById("profileLvl");
    const statMemes = document.getElementById("statMemes");
    const statScore = document.getElementById("statScore");
    const statLikes = document.getElementById("statLikes");
    const statDislikes = document.getElementById("statDislikes");
    const toast = document.getElementById("toast");

    function initials(name){
      const s = (name || "U").trim();
      return (s[0] || "U").toUpperCase();
    }

    function renderStats(){
      const info = getLevelInfo(state.user.xp);
      state.user.level = info.level;
      const lim = `${info.perDay}/–¥–µ–Ω—å, ${info.perHour}/—á–∞—Å`;
      profileName.textContent = state.user.name;
      bubbleAvatar.textContent = initials(state.user.name);
      profileAvatar.textContent = initials(state.user.name);

      profileLvl.textContent = `–£—Ä–æ–≤–µ–Ω—å ${info.level} ¬∑ ${info.title} ¬∑ XP ${state.user.xp} ¬∑ –ª–∏–º–∏—Ç: ${lim}`;
      statMemes.textContent = state.user.memesPosted;
      statScore.textContent = state.user.score;
      statLikes.textContent = state.user.likesReceived;
      statDislikes.textContent = state.user.dislikesReceived;
    }

    function scoreOf(m){ return (m.likes || 0) - (m.dislikes || 0); }

    function renderCard(m){
      cardWrap.innerHTML = "";

      const likeStamp = document.createElement("div");
      likeStamp.className = "stamp like";
      likeStamp.textContent = "LIKE";

      const dislikeStamp = document.createElement("div");
      dislikeStamp.className = "stamp dislike";
      dislikeStamp.textContent = "NOPE";

      const card = document.createElement("div");
      card.className = "memeCard";
      card.innerHTML = `
        <div class="memeMedia">
          <img src="${escapeHtml(m.img)}" alt="meme" />
          <div class="memeTop">
            <div class="authorBox">
              <div class="author">
                ${escapeHtml(m.author)}
                <span class="badge">@${escapeHtml(m.author.toLowerCase())}</span>
              </div>
              <div class="meta">
                <span>üëç ${m.likes}</span>
                <span>üëé ${m.dislikes}</span>
                <span>Score ${scoreOf(m)}</span>
              </div>
            </div>
            <div class="scoreBox">
              <div class="score">${scoreOf(m)} <small>score</small></div>
              <div style="font-size:12px;color:rgba(255,255,255,.70);margin-top:3px">long-press ‚Üí —Ä–µ–ø–æ—Ä—Ç</div>
            </div>
          </div>
          <!-- stamps -->
        </div>
        <div class="caption">
          <div class="text">
            <div class="line1">${escapeHtml(m.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è")}</div>
            <div class="line2">–°–≤–∞–π–ø ‚Üê –ª–∞–π–∫ ¬∑ —Å–≤–∞–π–ø ‚Üí –¥–∏–∑–ª–∞–π–∫</div>
          </div>
          <div class="hint">
            <span class="chip"></span>
            <span>–±–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤</span>
          </div>
        </div>
      `;
      card.querySelector(".memeMedia").appendChild(likeStamp);
      card.querySelector(".memeMedia").appendChild(dislikeStamp);

      cardWrap.appendChild(card);

      attachGestures(card, likeStamp, dislikeStamp);
    }

    function renderEmpty(){
      cardWrap.innerHTML = `
        <div class="memeCard" style="position:relative; display:flex; align-items:center; justify-content:center; text-align:center; padding: 24px;">
          <div style="max-width:420px">
            <div style="font-weight:950; font-size:20px; letter-spacing:.2px">–ú–µ–º—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å</div>
            <div style="margin-top:10px; color:var(--muted); line-height:1.35">
              –¢—ã –ø–æ—Å–º–æ—Ç—Ä–µ–ª –≤—Å—ë, —á—Ç–æ –µ—Å—Ç—å –≤ –¥–µ–º–æ. –í –ø—Ä–æ–¥–µ —Ç—É—Ç –±—É–¥–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–∞—è –ª–µ–Ω—Ç–∞.
            </div>
            <div style="margin-top:14px; display:flex; gap:10px; justify-content:center">
              <div class="btn" id="btnMore">–ü–µ—Ä–µ–º–µ—à–∞—Ç—å –∑–∞–Ω–æ–≤–æ</div>
            </div>
          </div>
        </div>
      `;
      document.getElementById("btnMore")?.addEventListener("click", ()=>{
        // demo: allow repeats by clearing seen
        state.seen.clear();
        rebuildQueue();
        nextMeme();
        showToast("–û–∫: –ª–µ–Ω—Ç–∞ –ø–µ—Ä–µ–º–µ—à–∞–Ω–∞ –∑–∞–Ω–æ–≤–æ");
      });
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }

    /*****************
     * Swipe gestures *
     *****************/
    function attachGestures(card, likeStamp, dislikeStamp){
      let startX = 0, startY = 0, dx = 0, dy = 0;
      let dragging = false;
      let longPressTimer = null;
      let longPressed = false;

      const THRESH = 92;  // swipe commit px
      const MAX_ROT = 12; // deg

      const onDown = (e) => {
        const p = point(e);
        startX = p.x; startY = p.y;
        dx = 0; dy = 0;
        dragging = true;
        longPressed = false;

        // long-press to report (ignore if user starts moving)
        longPressTimer = setTimeout(()=>{
          if(!dragging) return;
          longPressed = true;
          openReportForCurrent();
          // small haptic if telegram
          try{ TG?.HapticFeedback?.impactOccurred?.("light"); }catch(_){}
        }, 420);

        card.style.transition = "none";
      };

      const onMove = (e) => {
        if(!dragging) return;
        const p = point(e);
        dx = p.x - startX;
        dy = p.y - startY;

        if(Math.abs(dx) > 10 || Math.abs(dy) > 10){
          clearTimeout(longPressTimer);
        }

        // If long-press already triggered, ignore drag
        if(longPressed) return;

        // Only horizontal swipes
        const rot = clamp(dx / 18, -MAX_ROT, MAX_ROT);
        card.style.transform = `translate3d(${dx}px, ${dy*0.18}px, 0) rotate(${rot}deg)`;

        // stamps opacity
        const a = clamp(Math.abs(dx) / THRESH, 0, 1);
        if(dx < 0){
          likeStamp.classList.toggle("on", a > 0.12);
          dislikeStamp.classList.remove("on");
          likeStamp.style.opacity = a;
        }else{
          dislikeStamp.classList.toggle("on", a > 0.12);
          likeStamp.classList.remove("on");
          dislikeStamp.style.opacity = a;
        }
      };

      const onUp = () => {
        if(!dragging) return;
        dragging = false;
        clearTimeout(longPressTimer);

        if(longPressed){
          // report sheet already opened
          card.style.transform = "translate3d(0,0,0)";
          return;
        }

        const commit = Math.abs(dx) >= THRESH && Math.abs(dx) > Math.abs(dy);
        card.style.transition = "transform .22s cubic-bezier(.2,.85,.2,1)";

        if(!commit){
          likeStamp.classList.remove("on");
          dislikeStamp.classList.remove("on");
          likeStamp.style.opacity = 0;
          dislikeStamp.style.opacity = 0;
          card.style.transform = "translate3d(0,0,0) rotate(0deg)";
          return;
        }

        // Commit direction
        if(dx < 0){
          // like
          swipeOut(card, -1, ()=>{
            voteCurrent("like");
          });
        }else{
          // dislike
          swipeOut(card, +1, ()=>{
            voteCurrent("dislike");
          });
        }
      };

      card.addEventListener("pointerdown", onDown, {passive:true});
      window.addEventListener("pointermove", onMove, {passive:true});
      window.addEventListener("pointerup", onUp, {passive:true});
      window.addEventListener("pointercancel", onUp, {passive:true});

      function swipeOut(el, dir, done){
        const off = dir * (Math.min(window.innerWidth, 560) + 120);
        const rot = dir * 10;
        el.style.transition = "transform .26s cubic-bezier(.2,.85,.2,1)";
        el.style.transform = `translate3d(${off}px, 0, 0) rotate(${rot}deg)`;
        setTimeout(done, 170);
      }

      function point(e){
        if(e.touches?.[0]) return {x:e.touches[0].clientX, y:e.touches[0].clientY};
        return {x:e.clientX, y:e.clientY};
      }
    }

    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

    /****************
     * Voting logic *
     ****************/
    function voteCurrent(kind){
      const m = state.current;
      if(!m) return;

      // mark seen
      state.seen.add(m.id);
      state.lastAuthorId = m.authorId;

      if(kind === "like"){
        m.likes++;
        // author gains xp
        // demo: if user likes someone else's meme -> that author gains xp, but we track only user stats here
        // In prod: update author's stats in DB; here we only show global meme stats.
        showToast("üëç –õ–∞–π–∫");
        try{ TG?.HapticFeedback?.notificationOccurred?.("success"); }catch(_){}
      }else{
        m.dislikes++;
        showToast("üëé –î–∏–∑–ª–∞–π–∫");
        try{ TG?.HapticFeedback?.notificationOccurred?.("warning"); }catch(_){}
      }

      // in a real system: if THIS user is author -> update user stats; for demo we keep user's score from their posted memes
      // Move on
      nextMeme();
      // Update rating screen if open
      if(document.getElementById("ratingScreen").classList.contains("on")){
        renderRating();
      }
    }

    /*****************
     * Report / Admin *
     *****************/
    const REPORT_REASONS = [
      { id:"spam", label:"–°–ø–∞–º / —Ä–µ–∫–ª–∞–º–∞", hint:"—Å—Å—ã–ª–∫–∏, –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ" },
      { id:"abuse", label:"–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è", hint:"—Ç—Ä–∞–≤–ª—è, —É–Ω–∏–∂–µ–Ω–∏–µ" },
      { id:"adult", label:"18+ –∫–æ–Ω—Ç–µ–Ω—Ç", hint:"–Ω–µ–ø—Ä–∏–µ–º–ª–µ–º–æ" },
      { id:"violence", label:"–®–æ–∫ / –Ω–∞—Å–∏–ª–∏–µ", hint:"–∂–µ—Å—Ç—å" },
      { id:"other", label:"–î—Ä—É–≥–æ–µ", hint:"–ø—Ä–æ—á–µ–µ" },
    ];

    const overlay = document.getElementById("overlay");
    const reportSheet = document.getElementById("reportSheet");
    const reportTarget = document.getElementById("reportTarget");
    const reasonList = document.getElementById("reasonList");

    function openReportForCurrent(){
      const m = state.current;
      if(!m) return;
      state.report.openForMemeId = m.id;
      state.report.selectedReason = null;

      reportTarget.textContent = `–ú–µ–º: ${m.title || m.id} ¬∑ –∞–≤—Ç–æ—Ä: ${m.author}`;
      reasonList.innerHTML = "";

      for(const r of REPORT_REASONS){
        const el = document.createElement("div");
        el.className = "reason";
        el.innerHTML = `<div>
            <div class="l">${escapeHtml(r.label)}</div>
            <div class="r">${escapeHtml(r.hint)}</div>
          </div>
          <div style="color:var(--muted2); font-weight:900">–≤—ã–±—Ä–∞—Ç—å</div>`;
        el.addEventListener("click", ()=>{
          // select / toggle
          const isSel = state.report.selectedReason === r.id;
          state.report.selectedReason = isSel ? null : r.id;
          [...reasonList.children].forEach(ch => ch.classList.remove("sel"));
          if(!isSel) el.classList.add("sel");
        });
        reasonList.appendChild(el);
      }

      openSheet(reportSheet);
    }

    function sendReport(){
      const memeId = state.report.openForMemeId;
      const reason = state.report.selectedReason;
      if(!memeId) return;

      if(!reason){
        showToast("–í—ã–±–µ—Ä–∏ –ø—Ä–∏—á–∏–Ω—É –∏–ª–∏ –Ω–∞–∂–º–∏ –û—Ç–º–µ–Ω–∞");
        try{ TG?.HapticFeedback?.notificationOccurred?.("error"); }catch(_){}
        return;
      }

      const m = state.memes.find(x => x.id === memeId);
      if(m){
        m.reports = (m.reports || 0) + 1;
        state.hidden.add(m.id); // hide for this user
      }

      closeSheet(reportSheet);
      showToast("–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ ‚Äî –º–µ–º —Å–∫—Ä—ã—Ç –¥–ª—è —Ç–µ–±—è");

      // In production: send to backend -> admin chat:
      // POST /report {meme_id, reason, reporter_id}
      // Backend sends to Telegram admin chat with inline buttons (ban/delete/keep).
      console.log("[DEMO] Report sent:", { memeId, reason, reporter: state.user.id });

      nextMeme();
      if(document.getElementById("ratingScreen").classList.contains("on")){
        renderRating();
      }
    }

    /*****************
     * Profile / Sheets *
     *****************/
    const profileSheet = document.getElementById("profileSheet");
    document.getElementById("profileBubble").addEventListener("click", ()=> openSheet(profileSheet));
    document.getElementById("closeProfile").addEventListener("click", ()=> closeSheet(profileSheet));
    document.getElementById("closeReport").addEventListener("click", ()=> closeSheet(reportSheet));
    document.getElementById("cancelReport").addEventListener("click", ()=> closeSheet(reportSheet));
    document.getElementById("sendReport").addEventListener("click", sendReport);

    overlay.addEventListener("click", ()=>{
      closeSheet(profileSheet);
      closeSheet(reportSheet);
    });

    function openSheet(el){
      overlay.classList.add("on");
      el.classList.add("on");
      el.setAttribute("aria-hidden","false");
    }
    function closeSheet(el){
      el.classList.remove("on");
      el.setAttribute("aria-hidden","true");
      // if no sheets open -> hide overlay
      const anyOpen = document.querySelector(".sheet.on");
      if(!anyOpen) overlay.classList.remove("on");
    }

    /*****************
     * Rating screen *
     *****************/
    const ratingScreen = document.getElementById("ratingScreen");
    const ratingList = document.getElementById("ratingList");
    const tabMemes = document.getElementById("tabMemes");
    const tabAuthors = document.getElementById("tabAuthors");

    document.getElementById("btnRating").addEventListener("click", ()=>{
      closeSheet(profileSheet);
      openRating();
    });
    document.getElementById("closeRating").addEventListener("click", closeRating);

    tabMemes.addEventListener("click", ()=>{
      state.rating.mode = "memes";
      tabMemes.classList.add("on");
      tabAuthors.classList.remove("on");
      renderRating();
    });
    tabAuthors.addEventListener("click", ()=>{
      state.rating.mode = "authors";
      tabAuthors.classList.add("on");
      tabMemes.classList.remove("on");
      renderRating();
    });

    document.querySelectorAll(".filters .tab").forEach(t=>{
      t.addEventListener("click", ()=>{
        document.querySelectorAll(".filters .tab").forEach(x=>x.classList.remove("on"));
        t.classList.add("on");
        state.rating.range = t.getAttribute("data-range") || "day";
        renderRating();
      });
    });

    function openRating(){
      ratingScreen.classList.add("on");
      ratingScreen.setAttribute("aria-hidden","false");
      renderRating();
    }
    function closeRating(){
      ratingScreen.classList.remove("on");
      ratingScreen.setAttribute("aria-hidden","true");
    }

    function renderRating(){
      ratingList.innerHTML = "";
      if(state.rating.mode === "memes"){
        // sort by score desc, then likes
        const items = [...state.memes].sort((a,b)=>{
          const sa = scoreOf(a), sb = scoreOf(b);
          if(sb !== sa) return sb - sa;
          return (b.likes||0) - (a.likes||0);
        }).slice(0, 30);

        items.forEach((m, idx)=>{
          const row = document.createElement("div");
          row.className = "row";
          row.innerHTML = `
            <div class="thumb"><img src="${escapeHtml(m.img)}" alt=""></div>
            <div class="info">
              <div class="main">#${idx+1} ¬∑ ${escapeHtml(m.title || m.id)}</div>
              <div class="sub">${escapeHtml(m.author)} ¬∑ üëç ${m.likes} ¬∑ üëé ${m.dislikes} ¬∑ —Ä–µ–ø–æ—Ä—Ç–æ–≤ ${m.reports||0}</div>
            </div>
            <div class="rank">${scoreOf(m)}<span class="s">score</span></div>
          `;
          ratingList.appendChild(row);
        });
      }else{
        // aggregate authors from memes (demo)
        const map = new Map();
        for(const m of state.memes){
          const a = map.get(m.authorId) || { authorId:m.authorId, author:m.author, likes:0, dislikes:0, score:0, memes:0 };
          a.likes += m.likes||0;
          a.dislikes += m.dislikes||0;
          a.score += scoreOf(m);
          a.memes += 1;
          map.set(m.authorId, a);
        }
        const authors = [...map.values()].sort((x,y)=>{
          if(y.score !== x.score) return y.score - x.score;
          return y.likes - x.likes;
        }).slice(0, 30);

        authors.forEach((a, idx)=>{
          const row = document.createElement("div");
          row.className = "row";
          row.innerHTML = `
            <div class="thumb" style="display:flex;align-items:center;justify-content:center;font-weight:950">
              ${escapeHtml(a.author[0]?.toUpperCase() || "U")}
            </div>
            <div class="info">
              <div class="main">#${idx+1} ¬∑ ${escapeHtml(a.author)}</div>
              <div class="sub">–º–µ–º–æ–≤ ${a.memes} ¬∑ üëç ${a.likes} ¬∑ üëé ${a.dislikes}</div>
            </div>
            <div class="rank">${a.score}<span class="s">score</span></div>
          `;
          ratingList.appendChild(row);
        });
      }
    }

    /*****************
     * Add meme (demo) *
     *****************/
    const fileInput = document.getElementById("fileInput");
    document.getElementById("btnAddMeme").addEventListener("click", ()=>{
      closeSheet(profileSheet);
      addMemeFlow();
    });

    function addMemeFlow(){
      resetHourIfNeeded();
      const lvl = getLevelInfo(state.user.xp);

      // reset daily in demo? (in prod: by date)
      // Here: keep simple; you can implement day-key similar to hourKey
      if(state.user.postedToday >= lvl.perDay){
        showToast(`–õ–∏–º–∏—Ç –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: ${lvl.perDay}. –ü—Ä–æ–∫–∞—á–∞–π —É—Ä–æ–≤–µ–Ω—å –∏–ª–∏ –∂–¥–∏ –∑–∞–≤—Ç—Ä–∞.`);
        try{ TG?.HapticFeedback?.notificationOccurred?.("error"); }catch(_){}
        return;
      }
      if(state.user.postedThisHour >= lvl.perHour){
        showToast(`–õ–∏–º–∏—Ç –≤ —á–∞—Å: ${lvl.perHour}. –ü–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ.`);
        try{ TG?.HapticFeedback?.notificationOccurred?.("error"); }catch(_){}
        return;
      }

      fileInput.value = "";
      fileInput.click();
    }

    fileInput.addEventListener("change", async ()=>{
      const file = fileInput.files?.[0];
      if(!file) return;

      // create local object URL (demo). In prod: upload to backend, get URL.
      const url = URL.createObjectURL(file);

      const title = prompt("–ü–æ–¥–ø–∏—Å—å –∫ –º–µ–º—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):", "–ù–æ–≤—ã–π –º–µ–º");
      const newId = "u1_" + Math.random().toString(16).slice(2,10);

      const m = {
        id: newId,
        authorId: state.user.id,
        author: state.user.name,
        title: (title || "–ù–æ–≤—ã–π –º–µ–º").slice(0, 80),
        img: url,
        likes: 0,
        dislikes: 0,
        reports: 0
      };

      state.memes.unshift(m);
      state.user.memesPosted++;
      state.user.postedToday++;
      state.user.postedThisHour++;

      // Small XP reward for posting? optional:
      // state.user.xp += 2;

      renderStats();
      showToast("–ú–µ–º –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω ‚úÖ");

      // Put it into queue for other users (prod). For this user: mark as seen? Up to you.
      // Here: hide own meme from feed to avoid self-like:
      state.seen.add(m.id);

      rebuildQueue();
      if(!state.current) nextMeme();
      if(document.getElementById("ratingScreen").classList.contains("on")){
        renderRating();
      }
    });

    /*****************
     * Demo reset     *
     *****************/
    document.getElementById("btnResetDemo").addEventListener("click", ()=>{
      // reset state
      state.memes = demoMemes.map(m => ({...m}));
      state.seen.clear();
      state.hidden.clear();
      state.queue = [];
      state.current = null;
      state.lastAuthorId = null;
      state.user.xp = 0;
      state.user.level = 1;
      state.user.likesReceived = 0;
      state.user.dislikesReceived = 0;
      state.user.memesPosted = 0;
      state.user.score = 0;
      state.user.postedToday = 0;
      state.user.postedThisHour = 0;
      state.user.lastHourKey = hourKeyNow();

      renderStats();
      closeSheet(profileSheet);
      closeRating();
      rebuildQueue();
      nextMeme();
      showToast("–î–µ–º–æ —Å–±—Ä–æ—à–µ–Ω–æ");
    });

    /*****************
     * Toast helper   *
     *****************/
    let toastTimer = null;
    function showToast(text){
      toast.textContent = text;
      toast.classList.add("on");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> toast.classList.remove("on"), 1600);
    }

    /*****************
     * Init user info *
     *****************/
    function initUserFromTelegram(){
      // If opened inside Telegram, pull name.
      try{
        const u = TG?.initDataUnsafe?.user;
        if(u){
          state.user.id = String(u.id);
          state.user.name = u.first_name || u.username || "User";
        }
      }catch(e){}
    }

    /*****************
     * Boot           *
     *****************/
    initUserFromTelegram();
    renderStats();
    rebuildQueue();
    nextMeme();

    // Close report/profile if user presses ESC (desktop)
    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        closeSheet(profileSheet);
        closeSheet(reportSheet);
        closeRating();
      }
    });
  </script>
</body>
</html>
