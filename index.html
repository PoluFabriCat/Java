<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, viewport-fit=cover, user-scalable=no" />
  <meta name="color-scheme" content="dark light" />
  <title>MemeSwipe WebApp</title>

  <style>
    :root{
      --bg: #070A12;
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.62);
      --muted2: rgba(255,255,255,.42);
      --stroke: rgba(255,255,255,.10);

      --shadow: 0 24px 70px rgba(0,0,0,.55);
      --shadow2: 0 10px 30px rgba(0,0,0,.35);

      --radius: 26px;

      --like: #22E5A6;
      --dislike: #FF4D6D;
      --warn: #FFD166;

      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; }
    body{
      margin:0;
      color: var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      overflow:hidden;
      background:
        radial-gradient(1100px 700px at 20% -10%, rgba(79,119,255,.24), transparent 60%),
        radial-gradient(900px 600px at 115% 10%, rgba(34,229,166,.14), transparent 62%),
        radial-gradient(900px 600px at 80% 120%, rgba(255,77,109,.12), transparent 58%),
        linear-gradient(180deg, #060812 0%, #070A12 30%, #070A12 100%);
    }

    .app{
      height: 100%;
      width: 100%;
      display:flex;
      flex-direction:column;
      padding-top: calc(var(--safe-top) + 10px);
      padding-bottom: calc(var(--safe-bottom) + 10px);
    }

    /* Topbar */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 10px 14px 8px;
      gap: 12px;
      user-select:none;
    }
    .brand{ display:flex; align-items:center; gap:10px; min-width:0; }
    .logo{
      width: 36px; height:36px;
      border-radius: 14px;
      background:
        radial-gradient(18px 18px at 30% 35%, rgba(255,255,255,.30), transparent 60%),
        linear-gradient(135deg, rgba(79,119,255,.95), rgba(34,229,166,.88));
      box-shadow: var(--shadow2);
      position:relative;
      overflow:hidden;
    }
    .logo::after{
      content:"";
      position:absolute; inset:-40%;
      background: linear-gradient(120deg, transparent 35%, rgba(255,255,255,.22) 45%, transparent 55%);
      transform: rotate(18deg);
      animation: shine 6.5s linear infinite;
    }
    @keyframes shine{
      0%{ transform: translateX(-55%) rotate(18deg); opacity:0; }
      10%{ opacity:.65; }
      28%{ transform: translateX(65%) rotate(18deg); opacity:0; }
      100%{ transform: translateX(65%) rotate(18deg); opacity:0; }
    }
    .brandText{ min-width:0; }
    .title{
      font-weight: 950;
      letter-spacing: .2px;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .subtitle{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .hintPill{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.05);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 22px rgba(0,0,0,.22);
      color: rgba(255,255,255,.78);
      font-size: 12px;
      font-weight: 800;
      letter-spacing: .2px;
      white-space:nowrap;
    }

    /* Stage */
    .stage{
      flex:1;
      padding: 8px 14px 0;
      display:flex;
      align-items:stretch;
      justify-content:center;
      position:relative;
      min-height: 0;
      overflow:hidden;
    }
    .cardWrap{
      width: min(520px, 100%);
      position:relative;
      flex:1;
      min-height: 0;
      display:flex;
      align-items:stretch;
      justify-content:center;
    }

    .memeCard{
      width: 100%;
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(255,255,255,.11), rgba(255,255,255,.05));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:absolute;
      inset: 0;
      display:flex;
      flex-direction:column;
      transform: translate3d(0,0,0);
      will-change: transform;
      touch-action: pan-y;
    }

    .memeMedia{
      flex: 1;
      min-height: 0;
      position:relative;
      background: rgba(255,255,255,.03);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }

    .memeMedia img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scale(1.02);
      filter: saturate(1.06) contrast(1.03);
      user-select:none;
      -webkit-user-drag:none;
    }

    .memeMedia::after{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(900px 700px at 50% 10%, rgba(0,0,0,.08), transparent 55%),
        radial-gradient(900px 700px at 50% 110%, rgba(0,0,0,.35), transparent 55%);
      pointer-events:none;
    }

    .memeTop{
      position:absolute;
      left: 12px; right: 12px; top: 12px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 10px;
      pointer-events:none;
    }

    .glassBox{
      pointer-events:none;
      padding: 10px 12px;
      border-radius: 18px;
      background: rgba(0,0,0,.26);
      border: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(12px);
      box-shadow: 0 10px 26px rgba(0,0,0,.20);
    }

    .author{
      font-weight: 900;
      letter-spacing: .2px;
      font-size: 14px;
      line-height:1.2;
      display:flex;
      align-items:center;
      gap:8px;
      max-width: 64vw;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .tag{
      font-size: 11px;
      color: rgba(255,255,255,.72);
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      flex:0 0 auto;
    }

    .meta{
      margin-top: 4px;
      font-size: 12px;
      color: rgba(255,255,255,.72);
      display:flex; gap:10px; flex-wrap:wrap;
    }

    .score{
      font-weight: 950;
      font-size: 16px;
      letter-spacing: .2px;
      text-align:right;
    }
    .score small{
      font-weight: 850;
      color: rgba(255,255,255,.70);
      margin-left: 6px;
    }
    .microHint{
      margin-top: 3px;
      font-size: 12px;
      color: rgba(255,255,255,.68);
      text-align:right;
    }

    .caption{
      padding: 12px 14px;
      border-top: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 12px;
    }
    .caption .text{ min-width:0; }
    .line1{
      font-weight: 920;
      font-size: 14px;
      line-height: 1.2;
      margin-bottom: 2px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .line2{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    /* Center swipe indicator */
    .centerIndicator{
      position:absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%) scale(.92);
      opacity: 0;
      pointer-events:none;
      transition: opacity .10s ease, transform .10s ease;
      z-index: 5;
    }
    .centerIndicator.on{
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
    }
    .badgeBig{
      display:flex;
      align-items:center;
      gap: 10px;
      padding: 14px 16px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.28);
      backdrop-filter: blur(12px);
      box-shadow: 0 18px 44px rgba(0,0,0,.28);
      font-weight: 950;
      letter-spacing: .8px;
      text-transform: uppercase;
    }
    .badgeBig.like{ border-color: rgba(34,229,166,.45); box-shadow: 0 18px 44px rgba(34,229,166,.10); }
    .badgeBig.dislike{ border-color: rgba(255,77,109,.45); box-shadow: 0 18px 44px rgba(255,77,109,.10); }
    .badgeBig span{ font-size: 14px; }

    .icon{ width: 22px; height:22px; display:inline-block; }
    .icon svg{ width:100%; height:100%; display:block; }

    /* Dock */
    .dock{
      position: relative;
      width: 100%;
      display:flex;
      justify-content:center;
      padding: 10px 14px 0;
      pointer-events:none;
    }
    .dockInner{
      width: min(520px, 100%);
      position:relative;
      height: 86px;
      pointer-events:none;
    }
    .plate{
      pointer-events:none;
      position:absolute;
      left: 50%;
      bottom: -40px;
      transform: translateX(-50%);
      width: 190px;
      height: 128px;
      border-radius: 128px 128px 30px 30px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      backdrop-filter: blur(12px);
      box-shadow: 0 16px 34px rgba(0,0,0,.22);
    }
    .bubble{
      pointer-events:auto;
      position:absolute;
      left: 50%;
      bottom: 0;
      transform: translateX(-50%);
      width: 78px;
      height: 78px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: radial-gradient(18px 18px at 30% 30%, rgba(255,255,255,.26), transparent 60%),
                  linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow2);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      transition: transform .14s ease;
    }
    .bubble:active{ transform: translateX(-50%) scale(.97); }
    .avatar{
      width: 60px; height: 60px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 12px 24px rgba(0,0,0,.25);
      background: linear-gradient(135deg, rgba(79,119,255,.70), rgba(34,229,166,.60));
      display:flex; align-items:center; justify-content:center;
      font-weight: 950;
      letter-spacing:.4px;
      user-select:none;
    }

    /* Overlay / Sheets */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(10px);
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease;
      z-index: 50;
    }
    .overlay.on{ opacity: 1; pointer-events:auto; }

    .sheet{
      position: fixed;
      left: 0; right: 0;
      bottom: -110%;
      z-index: 60;
      transition: bottom .26s cubic-bezier(.2,.85,.2,1);
      padding: 10px 12px calc(var(--safe-bottom) + 12px);
      will-change: bottom;
    }
    .sheet.on{ bottom: 0; }

    .panel{
      width: min(560px, 100%);
      margin: 0 auto;
      border-radius: 28px;
      border: 1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    .grab{ display:flex; justify-content:center; padding: 12px 0 6px; }
    .grab .bar{ width: 44px; height: 5px; border-radius: 999px; background: rgba(255,255,255,.25); }

    .panelHeader{
      padding: 0 14px 10px;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap: 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .panelHeader .h{
      font-weight: 950;
      letter-spacing: .2px;
      font-size: 16px;
      padding-bottom: 10px;
    }
    .panelHeader .swipeHint{
      padding-bottom: 10px;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      white-space:nowrap;
    }

    .panelBody{ padding: 12px 14px 14px; }

    /* Profile layout (new) */
    .profilePreview{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      border-radius: 22px;
      overflow:hidden;
      position: relative;
    }
    .profilePreview .imgBox{
      height: 160px;
      background: rgba(255,255,255,.05);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
    }
    .profilePreview img{
      width:100%;
      height:100%;
      object-fit: cover;
      transform: scale(1.02);
      filter: saturate(1.06) contrast(1.03);
    }
    .profilePreview .overlayText{
      position:absolute;
      left: 12px; right: 12px; bottom: 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      pointer-events:none;
    }
    .previewChip{
      pointer-events:none;
      padding: 8px 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.26);
      backdrop-filter: blur(10px);
      font-weight: 950;
      letter-spacing:.2px;
      font-size: 12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 75%;
    }
    .previewChip2{
      padding: 8px 10px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.26);
      backdrop-filter: blur(10px);
      font-weight: 950;
      font-size: 12px;
      white-space:nowrap;
    }

    .profileIdentity{
      display:flex;
      align-items:center;
      gap: 12px;
      padding: 12px 2px 8px;
    }
    .pAvatar{
      width: 56px; height:56px; border-radius:999px;
      background: linear-gradient(135deg, rgba(79,119,255,.72), rgba(34,229,166,.60));
      border: 1px solid rgba(255,255,255,.16);
      display:flex; align-items:center; justify-content:center;
      font-weight: 950;
    }
    .name{ font-weight: 950; letter-spacing:.2px; font-size: 16px; }
    .lvl{ margin-top:2px; font-size:12px; color: var(--muted); font-weight: 800; }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .statCard{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      border-radius: 18px;
      padding: 12px 12px;
    }
    .statCard .k{ color: var(--muted); font-size:12px; font-weight:800; }
    .statCard .v{ font-weight: 950; font-size: 18px; margin-top:2px; }

    .btnRow{ display:flex; gap:10px; padding-top: 12px; }
    .btn{
      flex:1;
      padding: 12px 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      font-weight: 900;
      letter-spacing: .2px;
      cursor:pointer;
      user-select:none;
      text-align:center;
      transition: transform .12s ease;
    }
    .btn:active{ transform: scale(.98); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(79,119,255,.72), rgba(34,229,166,.56));
      border-color: rgba(255,255,255,.18);
    }

    /* Report reasons */
    .reasonList{ display:flex; flex-direction:column; gap: 8px; padding-top: 6px; }
    .reason{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      padding: 12px 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
      cursor:pointer;
      user-select:none;
      transition: transform .10s ease;
    }
    .reason:active{ transform: scale(.99); }
    .reason .l{ font-weight: 900; letter-spacing: .2px; }
    .reason .r{ font-size: 12px; color: var(--muted); }

    /* Rating screen */
    .screen{
      position: fixed;
      inset: 0;
      z-index: 80;
      transform: translateY(12px);
      opacity: 0;
      pointer-events:none;
      transition: opacity .16s ease, transform .16s ease;
      padding-top: calc(var(--safe-top) + 10px);
      padding-bottom: calc(var(--safe-bottom) + 12px);
      overflow:hidden;
    }
    .screen.on{ opacity: 1; pointer-events:auto; transform: translateY(0); }
    .screen .wrap{
      height:100%;
      width: min(560px, 100%);
      margin: 0 auto;
      padding: 0 14px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .screenTop{
      display:flex; align-items:center; justify-content:space-between;
      padding: 8px 0 2px;
      gap: 10px;
    }
    .screenTop .t{
      font-weight: 950;
      letter-spacing:.2px;
      font-size: 18px;
    }

    .tabs{
      display:flex; gap:8px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      padding: 6px;
      width: fit-content;
    }
    .tab{
      padding: 8px 10px;
      border-radius: 999px;
      font-weight: 900;
      font-size: 12px;
      color: rgba(255,255,255,.72);
      cursor:pointer;
      user-select:none;
      border:1px solid transparent;
      transition: background .12s ease, color .12s ease;
      white-space:nowrap;
    }
    .tab.on{
      background: rgba(255,255,255,.12);
      color: rgba(255,255,255,.92);
      border-color: rgba(255,255,255,.14);
    }

    .list{
      flex:1;
      min-height:0;
      overflow:auto;
      padding-bottom: 6px;
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,.18) transparent;
    }
    .row{
      display:flex;
      gap: 10px;
      padding: 10px 10px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.10);
      border-radius: 18px;
      margin-bottom: 10px;
      align-items:center;
    }
    .thumb{
      width: 54px; height:54px;
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.12);
      flex:0 0 auto;
      background: rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:center;
      font-weight: 950;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; }
    .info{ min-width:0; flex:1; }
    .main{
      font-weight: 950;
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .sub{
      margin-top:2px;
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .rank{
      flex:0 0 auto;
      font-weight: 950;
      color: rgba(255,255,255,.86);
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 8px 10px;
      text-align:right;
      min-width: 78px;
    }
    .rank .s{
      display:block; font-size: 11px; color: var(--muted);
      font-weight: 900;
      margin-top:2px;
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: calc(var(--safe-bottom) + 96px);
      transform: translateX(-50%) translateY(10px);
      z-index: 90;
      opacity: 0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.30);
      backdrop-filter: blur(12px);
      box-shadow: var(--shadow2);
      font-weight: 900;
      color: rgba(255,255,255,.92);
      max-width: min(520px, 92vw);
      text-align:center;
    }
    .toast.on{ opacity: 1; transform: translateX(-50%) translateY(0); }

    /* Shake on long press */
    @keyframes shake {
      0% { transform: translate3d(0,0,0) rotate(0deg); }
      20%{ transform: translate3d(-1px, 0,0) rotate(-.35deg); }
      40%{ transform: translate3d(1px, 0,0) rotate(.35deg); }
      60%{ transform: translate3d(-1px, 0,0) rotate(-.35deg); }
      80%{ transform: translate3d(1px, 0,0) rotate(.35deg); }
      100%{ transform: translate3d(0,0,0) rotate(0deg); }
    }
    .isShaking{ animation: shake .18s linear infinite; }

    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; }
    }
  </style>
</head>

<body>
  <div class="app" id="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div class="brandText">
          <div class="title">MemeSwipe</div>
          <div class="subtitle">—Å–≤–∞–π–ø ‚Üê –ª–∞–π–∫ ¬∑ —Å–≤–∞–π–ø ‚Üí –¥–∏–∑–ª–∞–π–∫ ¬∑ –≤–≤–µ—Ä—Ö ‚Äî –ø—Ä–æ—Ñ–∏–ª—å</div>
        </div>
      </div>
      <div class="hintPill">–±–µ–∑ –ø–æ–≤—Ç–æ—Ä–æ–≤</div>
    </div>

    <div class="stage" id="stage">
      <div class="cardWrap" id="cardWrap"></div>
    </div>

    <div class="dock">
      <div class="dockInner">
        <div class="plate"></div>
        <div class="bubble" id="profileBubble" aria-label="–ü—Ä–æ—Ñ–∏–ª—å">
          <div class="avatar" id="bubbleAvatar">A</div>
        </div>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay"></div>

  <!-- Profile sheet (new layout) -->
  <div class="sheet" id="profileSheet" aria-hidden="true">
    <div class="panel" data-sheet="profile">
      <div class="grab"><div class="bar"></div></div>
      <div class="panelHeader">
        <div class="h">–ü—Ä–æ—Ñ–∏–ª—å</div>
        <div class="swipeHint">—Å–≤–∞–π–ø –≤–Ω–∏–∑ ‚Äî –∑–∞–∫—Ä—ã—Ç—å</div>
      </div>
      <div class="panelBody">
        <div class="profilePreview">
          <div class="imgBox" id="profilePreviewBox">
            <!-- image injected -->
          </div>
          <div class="overlayText">
            <div class="previewChip" id="profilePreviewTitle">–¢–µ–∫—É—â–∏–π –º–µ–º</div>
            <div class="previewChip2" id="profilePreviewScore">score 0</div>
          </div>
        </div>

        <div class="profileIdentity">
          <div class="pAvatar" id="profileAvatar">A</div>
          <div style="min-width:0">
            <div class="name" id="profileName">User</div>
            <div class="lvl" id="profileLvl">–£—Ä–æ–≤–µ–Ω—å 1 ¬∑ XP 0</div>
          </div>
        </div>

        <div class="grid2">
          <div class="statCard">
            <div class="k">–¢–≤–æ–∏ –º–µ–º—ã</div>
            <div class="v" id="statMemes">0</div>
          </div>
          <div class="statCard">
            <div class="k">–û–±—â–∏–π score</div>
            <div class="v" id="statScore">0</div>
          </div>
          <div class="statCard">
            <div class="k">–õ–∞–π–∫–∏</div>
            <div class="v" id="statLikes">0</div>
          </div>
          <div class="statCard">
            <div class="k">–î–∏–∑–ª–∞–π–∫–∏</div>
            <div class="v" id="statDislikes">0</div>
          </div>
        </div>

        <div class="btnRow">
          <div class="btn primary" id="btnRating">–û–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥</div>
          <div class="btn" id="btnAddMeme">–î–æ–±–∞–≤–∏—Ç—å –º–µ–º</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Report sheet (tap reason = send; swipe down to close) -->
  <div class="sheet" id="reportSheet" aria-hidden="true">
    <div class="panel" data-sheet="report">
      <div class="grab"><div class="bar"></div></div>
      <div class="panelHeader">
        <div class="h">–ñ–∞–ª–æ–±–∞</div>
        <div class="swipeHint">–≤—ã–±–µ—Ä–∏ –ø—Ä–∏—á–∏–Ω—É ¬∑ –≤–Ω–∏–∑ ‚Äî –∑–∞–∫—Ä—ã—Ç—å</div>
      </div>
      <div class="panelBody">
        <div style="color:var(--muted); font-size:12px; margin-bottom:8px" id="reportTarget">–ú–µ–º: ‚Äî</div>
        <div class="reasonList" id="reasonList"></div>
      </div>
    </div>
  </div>

  <!-- Rating screen (fixed) -->
  <div class="screen" id="ratingScreen" aria-hidden="true">
    <div class="wrap">
      <div class="screenTop">
        <div class="t">–û–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥</div>
        <div class="hintPill" id="closeRating" style="cursor:pointer">–Ω–∞–∑–∞–¥</div>
      </div>

      <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
        <div class="tabs" id="modeTabs">
          <div class="tab on" data-mode="memes">–ú–µ–º—ã</div>
          <div class="tab" data-mode="authors">–ê–≤—Ç–æ—Ä—ã</div>
        </div>
        <div class="tabs" id="rangeTabs">
          <div class="tab on" data-range="day">–°–µ–≥–æ–¥–Ω—è</div>
          <div class="tab" data-range="week">–ù–µ–¥–µ–ª—è</div>
          <div class="tab" data-range="all">–í—Å—ë</div>
        </div>
      </div>

      <div class="list" id="ratingList"></div>
    </div>
  </div>

  <div class="toast" id="toast">‚Äî</div>
  <input type="file" id="fileInput" accept="image/*" style="display:none" />

  <script>
    /***********************
     * Telegram WebApp fit *
     ***********************/
    const TG = window.Telegram?.WebApp;
    try{
      TG?.ready();
      TG?.expand();
      TG?.setBackgroundColor?.("#070A12");
    }catch(e){}

    /****************
     * Demo content *
     ****************/
    const demoMemes = [
      { id: "m1", authorId:"u2", author:"Sasha", title:"–ö–æ–≥–¥–∞ –¥–µ–¥–ª–∞–π–Ω –±—ã–ª –≤—á–µ—Ä–∞", img:"https://picsum.photos/seed/meme401/900/1200", likes: 12, dislikes: 3, reports:0 },
      { id: "m2", authorId:"u3", author:"Olya", title:"–°–¥–∞–ª –ª–∞–±—É‚Ä¶ –Ω–æ –Ω–µ —Ç—É", img:"https://picsum.photos/seed/meme402/900/1200", likes: 4, dislikes: 6, reports:0 },
      { id: "m3", authorId:"u4", author:"Tim", title:"–Ø: –Ω–∞—á–Ω—É —Å –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞", img:"https://picsum.photos/seed/meme403/900/1200", likes: 20, dislikes: 5, reports:0 },
      { id: "m4", authorId:"u5", author:"Nastya", title:"–ö–æ–≥–¥–∞ –ø—Ä–µ–ø–æ–¥ —Å–∫–∞–∑–∞–ª '—ç—Ç–æ –ª–µ–≥–∫–æ'", img:"https://picsum.photos/seed/meme404/900/1200", likes: 8, dislikes: 1, reports:0 },
      { id: "m5", authorId:"u6", author:"Max", title:"–ö–æ–º–º–∏—Ç: fix", img:"https://picsum.photos/seed/meme405/900/1200", likes: 2, dislikes: 9, reports:0 },
      { id: "m6", authorId:"u7", author:"Ira", title:"–Ø –ø–æ—Å–ª–µ 2 —á–∞—Å–æ–≤ —Å–Ω–∞", img:"https://picsum.photos/seed/meme406/900/1200", likes: 15, dislikes: 2, reports:0 },
      { id: "m7", authorId:"u8", author:"Den", title:"–°–µ–º–∏–Ω–∞—Ä ‚Äî —ç—Ç–æ –æ—Ç–¥—ã—Ö", img:"https://picsum.photos/seed/meme407/900/1200", likes: 7, dislikes: 7, reports:0 },
      { id: "m8", authorId:"u9", author:"Vika", title:"–°–ª—É—á–∞–π–Ω–æ —É–¥–∞–ª–∏–ª –ø–∞–ø–∫—É project", img:"https://picsum.photos/seed/meme408/900/1200", likes: 19, dislikes: 4, reports:0 },
    ];

    const state = {
      user: {
        id: "u1",
        name: "Aceton",
        xp: 0,
        level: 1,
        likesReceived: 0,
        dislikesReceived: 0,
        memesPosted: 0,
        score: 0,
        postedToday: 0,
        postedThisHour: 0,
        lastHourKey: hourKeyNow(),
      },
      memes: demoMemes.map(m => ({...m})),
      seen: new Set(),
      hidden: new Set(),
      queue: [],
      current: null,
      lastAuthorId: null,

      report: { openForMemeId: null },
      rating: { mode: "memes", range: "day" },
      ui: { cardDragging: false }
    };

    /***********************
     * Levels / posting caps *
     ***********************/
    const LEVELS = [
      { level: 1, xpNeed: 0,   perDay: 3,  perHour: 2, title:"–ù–æ–≤–∏—á–æ–∫" },
      { level: 2, xpNeed: 40,  perDay: 5,  perHour: 3, title:"–ú–µ–º–µ—Ä" },
      { level: 3, xpNeed: 120, perDay: 8,  perHour: 4, title:"–ú–µ–º–æ–ª–æ–≥" },
      { level: 4, xpNeed: 260, perDay: 12, perHour: 5, title:"–¢–æ–ø—á–∏–∫" },
      { level: 5, xpNeed: 520, perDay: 20, perHour: 6, title:"–ö–æ—Ä–æ–ª—å –º–µ–º–æ–≤" },
    ];
    function getLevelInfo(xp){
      let cur = LEVELS[0];
      for(const l of LEVELS) if(xp >= l.xpNeed) cur = l;
      return cur;
    }

    function hourKeyNow(){
      const d = new Date();
      return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()} ${d.getHours()}`;
    }
    function resetHourIfNeeded(){
      const k = hourKeyNow();
      if(state.user.lastHourKey !== k){
        state.user.lastHourKey = k;
        state.user.postedThisHour = 0;
      }
    }

    /*****************
     * Helpers *
     *****************/
    function initials(name){
      const s = (name || "U").trim();
      return (s[0] || "U").toUpperCase();
    }
    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[c]));
    }
    function scoreOf(m){ return (m.likes || 0) - (m.dislikes || 0); }
    function fisherYates(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

    /*****************
     * Feed selection *
     *****************/
    function rebuildQueue(){
      const eligible = state.memes.filter(m => !state.seen.has(m.id) && !state.hidden.has(m.id));
      const shuffled = eligible.map(m => m.id);
      fisherYates(shuffled);

      if(state.lastAuthorId){
        for(let i=0;i<Math.min(6, shuffled.length);i++){
          const mm = state.memes.find(x => x.id === shuffled[i]);
          if(mm && mm.authorId !== state.lastAuthorId){
            [shuffled[0], shuffled[i]] = [shuffled[i], shuffled[0]];
            break;
          }
        }
      }
      state.queue = shuffled;
    }

    function nextMeme(){
      if(state.queue.length === 0) rebuildQueue();
      if(state.queue.length === 0){ renderEmpty(); return; }

      let id = state.queue.shift();
      let m = state.memes.find(x => x.id === id);

      if(state.lastAuthorId && m && m.authorId === state.lastAuthorId){
        let swapIdx = -1;
        for(let i=0;i<Math.min(8, state.queue.length);i++){
          const mm = state.memes.find(x => x.id === state.queue[i]);
          if(mm && mm.authorId !== state.lastAuthorId){ swapIdx = i; break; }
        }
        if(swapIdx >= 0){
          const alt = state.queue.splice(swapIdx, 1)[0];
          state.queue.unshift(id);
          id = alt;
          m = state.memes.find(x => x.id === id);
        }
      }

      state.current = m;
      renderCard(m);
      syncProfilePreview(); // keep profile in sync even if closed
    }

    /****************
     * UI elements *
     ****************/
    const stage = document.getElementById("stage");
    const cardWrap = document.getElementById("cardWrap");

    const bubbleAvatar = document.getElementById("bubbleAvatar");
    const profileAvatar = document.getElementById("profileAvatar");
    const profileName = document.getElementById("profileName");
    const profileLvl = document.getElementById("profileLvl");
    const statMemes = document.getElementById("statMemes");
    const statScore = document.getElementById("statScore");
    const statLikes = document.getElementById("statLikes");
    const statDislikes = document.getElementById("statDislikes");

    const profilePreviewBox = document.getElementById("profilePreviewBox");
    const profilePreviewTitle = document.getElementById("profilePreviewTitle");
    const profilePreviewScore = document.getElementById("profilePreviewScore");

    const toast = document.getElementById("toast");

    function renderStats(){
      const info = getLevelInfo(state.user.xp);
      state.user.level = info.level;

      bubbleAvatar.textContent = initials(state.user.name);
      profileAvatar.textContent = initials(state.user.name);
      profileName.textContent = state.user.name;

      profileLvl.textContent = `–£—Ä–æ–≤–µ–Ω—å ${info.level} ¬∑ ${info.title} ¬∑ XP ${state.user.xp} ¬∑ –ª–∏–º–∏—Ç: ${info.perDay}/–¥–µ–Ω—å, ${info.perHour}/—á–∞—Å`;
      statMemes.textContent = state.user.memesPosted;
      statScore.textContent = state.user.score;
      statLikes.textContent = state.user.likesReceived;
      statDislikes.textContent = state.user.dislikesReceived;
    }

    function syncProfilePreview(){
      const m = state.current;
      if(!m){
        profilePreviewBox.innerHTML = `<div style="color:var(--muted);font-weight:900;padding:24px">–ù–µ—Ç –º–µ–º–∞</div>`;
        profilePreviewTitle.textContent = "–¢–µ–∫—É—â–∏–π –º–µ–º";
        profilePreviewScore.textContent = "score 0";
        return;
      }
      profilePreviewBox.innerHTML = `<img src="${escapeHtml(m.img)}" alt="">`;
      profilePreviewTitle.textContent = m.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
      profilePreviewScore.textContent = `score ${scoreOf(m)}`;
    }

    function likeIcon(color){
      return `
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M9.5 10.2V20H6.2c-1 0-1.7-.8-1.7-1.7v-6.1c0-.9.7-1.7 1.7-1.7H9.5Z" fill="rgba(255,255,255,.18)" stroke="rgba(255,255,255,.18)"/>
            <path d="M9.5 10.2 13 3.7c.5-1 1.8-1.4 2.9-.9.8.4 1.2 1.3 1.1 2.1l-.6 3.2h3.3c1.2 0 2.1 1.1 1.9 2.2l-1.3 7.3c-.2.9-1 1.6-1.9 1.6H9.5" stroke="${color}" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>
          </svg>
        </span>`;
    }
    function dislikeIcon(color){
      return `
        <span class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M14.5 13.8V4h3.3c1 0 1.7.8 1.7 1.7v6.1c0 .9-.7 1.7-1.7 1.7h-3.3Z" fill="rgba(255,255,255,.18)" stroke="rgba(255,255,255,.18)"/>
            <path d="M14.5 13.8 11 20.3c-.5 1-1.8 1.4-2.9.9-.8-.4-1.2-1.3-1.1-2.1l.6-3.2H4.3c-1.2 0-2.1-1.1-1.9-2.2l1.3-7.3c.2-.9 1-1.6 1.9-1.6h8.9" stroke="${color}" stroke-width="2" stroke-linejoin="round" stroke-linecap="round"/>
          </svg>
        </span>`;
    }

    function renderCard(m){
      cardWrap.innerHTML = "";

      const card = document.createElement("div");
      card.className = "memeCard";
      card.innerHTML = `
        <div class="memeMedia">
          <img src="${escapeHtml(m.img)}" alt="meme" />
          <div class="memeTop">
            <div class="glassBox">
              <div class="author">
                ${escapeHtml(m.author)}
                <span class="tag">@${escapeHtml(m.author.toLowerCase())}</span>
              </div>
              <div class="meta">
                <span>üëç ${m.likes}</span>
                <span>üëé ${m.dislikes}</span>
                <span>score ${scoreOf(m)}</span>
              </div>
            </div>
            <div class="glassBox">
              <div class="score">${scoreOf(m)} <small>score</small></div>
              <div class="microHint">—É–¥–µ—Ä–∂–∞–Ω–∏–µ ‚Äî –∂–∞–ª–æ–±–∞</div>
            </div>
          </div>

          <div class="centerIndicator" id="centerIndicator">
            <div class="badgeBig like" id="badgeLike" style="display:none">
              ${likeIcon("rgba(34,229,166,.95)")}
              <span>LIKE</span>
            </div>
            <div class="badgeBig dislike" id="badgeDislike" style="display:none">
              ${dislikeIcon("rgba(255,77,109,.95)")}
              <span>NOPE</span>
            </div>
          </div>
        </div>

        <div class="caption">
          <div class="text">
            <div class="line1">${escapeHtml(m.title || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è")}</div>
            <div class="line2">–≤–≤–µ—Ä—Ö ‚Äî –ø—Ä–æ—Ñ–∏–ª—å ¬∑ —É–¥–µ—Ä–∂–∞–Ω–∏–µ ‚Äî –∂–∞–ª–æ–±–∞</div>
          </div>
        </div>
      `;

      cardWrap.appendChild(card);

      const indicator = card.querySelector("#centerIndicator");
      const badgeLike = card.querySelector("#badgeLike");
      const badgeDislike = card.querySelector("#badgeDislike");

      attachCardGestures(card, indicator, badgeLike, badgeDislike);
    }

    function renderEmpty(){
      cardWrap.innerHTML = `
        <div class="memeCard" style="position:relative; display:flex; align-items:center; justify-content:center; text-align:center; padding: 24px;">
          <div style="max-width:420px">
            <div style="font-weight:950; font-size:20px; letter-spacing:.2px">–ú–µ–º—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å</div>
            <div style="margin-top:10px; color:var(--muted); line-height:1.35">
              –í –¥–µ–º–æ —Ç—ã –ø–æ—Å–º–æ—Ç—Ä–µ–ª –≤—Å—ë. –í –ø—Ä–æ–¥–µ –ª–µ–Ω—Ç–∞ –±—É–¥–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π.
            </div>
            <div style="margin-top:14px; display:flex; gap:10px; justify-content:center">
              <div class="btn" id="btnMore">–ü–µ—Ä–µ–º–µ—à–∞—Ç—å –∑–∞–Ω–æ–≤–æ</div>
            </div>
          </div>
        </div>
      `;
      document.getElementById("btnMore")?.addEventListener("click", ()=>{
        state.seen.clear();
        rebuildQueue();
        nextMeme();
        showToast("–õ–µ–Ω—Ç–∞ –ø–µ—Ä–µ–º–µ—à–∞–Ω–∞");
      });
    }

    /*****************
     * Gestures: card swipe / long press
     *****************/
    function attachCardGestures(card, indicator, badgeLike, badgeDislike){
      let startX = 0, startY = 0, dx = 0, dy = 0;
      let dragging = false;
      let longPressTimer = null;
      let longPressed = false;

      const THRESH = 92;
      const MAX_ROT = 10;

      const onDown = (e) => {
        state.ui.cardDragging = true;
        dragging = true;
        longPressed = false;

        startX = e.clientX; startY = e.clientY;
        dx = 0; dy = 0;

        card.style.transition = "none";

        longPressTimer = setTimeout(()=>{
          if(!dragging) return;
          longPressed = true;
          card.classList.add("isShaking");
          setTimeout(()=>{
            if(!dragging) return;
            card.classList.remove("isShaking");
            openReportForCurrent();
            try{ TG?.HapticFeedback?.impactOccurred?.("light"); }catch(_){}
          }, 180);
        }, 420);
      };

      const onMove = (e) => {
        if(!dragging) return;

        dx = e.clientX - startX;
        dy = e.clientY - startY;

        if(Math.abs(dx) > 10 || Math.abs(dy) > 10){
          clearTimeout(longPressTimer);
          card.classList.remove("isShaking");
        }
        if(longPressed) return;

        const strength = clamp(Math.abs(dx) / THRESH, 0, 1);
        if(Math.abs(dx) > 8){
          indicator.classList.add("on");
          indicator.style.opacity = String(0.25 + strength * 0.75);
          if(dx < 0){
            badgeLike.style.display = "flex";
            badgeDislike.style.display = "none";
          }else{
            badgeLike.style.display = "none";
            badgeDislike.style.display = "flex";
          }
        }else{
          indicator.classList.remove("on");
          indicator.style.opacity = "0";
          badgeLike.style.display = "none";
          badgeDislike.style.display = "none";
        }

        const rot = clamp(dx / 20, -MAX_ROT, MAX_ROT);
        card.style.transform = `translate3d(${dx}px, ${dy*0.12}px, 0) rotate(${rot}deg)`;
      };

      const onUp = () => {
        if(!dragging) return;
        dragging = false;
        state.ui.cardDragging = false;
        clearTimeout(longPressTimer);
        card.classList.remove("isShaking");

        if(longPressed){
          indicator.classList.remove("on");
          indicator.style.opacity = "0";
          badgeLike.style.display = "none";
          badgeDislike.style.display = "none";
          card.style.transform = "translate3d(0,0,0) rotate(0deg)";
          return;
        }

        const commit = Math.abs(dx) >= THRESH && Math.abs(dx) > Math.abs(dy);
        card.style.transition = "transform .22s cubic-bezier(.2,.85,.2,1)";

        if(!commit){
          indicator.classList.remove("on");
          indicator.style.opacity = "0";
          badgeLike.style.display = "none";
          badgeDislike.style.display = "none";
          card.style.transform = "translate3d(0,0,0) rotate(0deg)";
          return;
        }

        if(dx < 0){
          swipeOut(card, -1, ()=> voteCurrent("like"));
        }else{
          swipeOut(card, +1, ()=> voteCurrent("dislike"));
        }
      };

      card.addEventListener("pointerdown", onDown, {passive:true});
      window.addEventListener("pointermove", onMove, {passive:true});
      window.addEventListener("pointerup", onUp, {passive:true});
      window.addEventListener("pointercancel", onUp, {passive:true});

      function swipeOut(el, dir, done){
        indicator.classList.remove("on");
        const off = dir * (Math.min(window.innerWidth, 560) + 140);
        const rot = dir * 10;
        el.style.transition = "transform .26s cubic-bezier(.2,.85,.2,1)";
        el.style.transform = `translate3d(${off}px, 0, 0) rotate(${rot}deg)`;
        setTimeout(done, 170);
      }
    }

    /****************
     * Voting
     ****************/
    function voteCurrent(kind){
      const m = state.current;
      if(!m) return;

      state.seen.add(m.id);
      state.lastAuthorId = m.authorId;

      if(kind === "like"){
        m.likes++;
        showToast("–õ–∞–π–∫");
        try{ TG?.HapticFeedback?.notificationOccurred?.("success"); }catch(_){}
      }else{
        m.dislikes++;
        showToast("–î–∏–∑–ª–∞–π–∫");
        try{ TG?.HapticFeedback?.notificationOccurred?.("warning"); }catch(_){}
      }

      nextMeme();
      if(document.getElementById("ratingScreen").classList.contains("on")) renderRating();
    }

    /*****************
     * Sheets / overlay
     *****************/
    const overlay = document.getElementById("overlay");
    const profileSheet = document.getElementById("profileSheet");
    const reportSheet = document.getElementById("reportSheet");

    function openSheet(el){
      overlay.classList.add("on");
      el.classList.add("on");
      el.setAttribute("aria-hidden","false");
      if(el === profileSheet) syncProfilePreview();
    }
    function closeSheet(el){
      el.classList.remove("on");
      el.setAttribute("aria-hidden","true");
      const anyOpen = document.querySelector(".sheet.on");
      if(!anyOpen) overlay.classList.remove("on");
    }

    overlay.addEventListener("click", ()=>{
      closeSheet(profileSheet);
      closeSheet(reportSheet);
    });

    document.getElementById("profileBubble").addEventListener("click", ()=> openSheet(profileSheet));

    // swipe down to close sheet
    function enableSwipeDownToClose(panelEl, sheetEl){
      let sy=0, sx=0, dragging=false;
      panelEl.addEventListener("pointerdown", (e)=>{
        dragging=true;
        sx=e.clientX; sy=e.clientY;
      }, {passive:true});
      window.addEventListener("pointerup", ()=>{ dragging=false; }, {passive:true});
      window.addEventListener("pointermove", (e)=>{
        if(!dragging) return;
        const dy = e.clientY - sy;
        const dx = e.clientX - sx;
        if(dy > 90 && Math.abs(dy) > Math.abs(dx)*1.2){
          dragging=false;
          closeSheet(sheetEl);
          try{ TG?.HapticFeedback?.impactOccurred?.("light"); }catch(_){}
        }
      }, {passive:true});
    }
    enableSwipeDownToClose(profileSheet.querySelector(".panel"), profileSheet);
    enableSwipeDownToClose(reportSheet.querySelector(".panel"), reportSheet);

    // global swipe up -> open profile (when not dragging card)
    (function enableGlobalSwipeUp(){
      let sx=0, sy=0, tracking=false;
      window.addEventListener("pointerdown", (e)=>{
        if(document.querySelector(".sheet.on") || document.getElementById("ratingScreen").classList.contains("on")) return;
        tracking = true;
        sx = e.clientX; sy = e.clientY;
      }, {passive:true});

      window.addEventListener("pointermove", (e)=>{
        if(!tracking) return;
        if(state.ui.cardDragging) return;
        const dy = e.clientY - sy;
        const dx = e.clientX - sx;
        if(dy < -110 && Math.abs(dy) > Math.abs(dx)*1.2){
          tracking = false;
          openSheet(profileSheet);
          try{ TG?.HapticFeedback?.impactOccurred?.("light"); }catch(_){}
        }
      }, {passive:true});

      window.addEventListener("pointerup", ()=>{ tracking=false; }, {passive:true});
      window.addEventListener("pointercancel", ()=>{ tracking=false; }, {passive:true});
    })();

    /*****************
     * Report
     *****************/
    const REPORT_REASONS = [
      { id:"spam", label:"–°–ø–∞–º / —Ä–µ–∫–ª–∞–º–∞", hint:"—Å—Å—ã–ª–∫–∏, –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–µ" },
      { id:"abuse", label:"–û—Å–∫–æ—Ä–±–ª–µ–Ω–∏—è", hint:"—Ç—Ä–∞–≤–ª—è, —É–Ω–∏–∂–µ–Ω–∏–µ" },
      { id:"adult", label:"18+ –∫–æ–Ω—Ç–µ–Ω—Ç", hint:"–Ω–µ–ø—Ä–∏–µ–º–ª–µ–º–æ" },
      { id:"violence", label:"–®–æ–∫ / –Ω–∞—Å–∏–ª–∏–µ", hint:"–∂–µ—Å—Ç—å" },
      { id:"other", label:"–î—Ä—É–≥–æ–µ", hint:"–ø—Ä–æ—á–µ–µ" },
    ];
    const reportTarget = document.getElementById("reportTarget");
    const reasonList = document.getElementById("reasonList");

    function openReportForCurrent(){
      const m = state.current;
      if(!m) return;
      state.report.openForMemeId = m.id;

      reportTarget.textContent = `–ú–µ–º: ${m.title || m.id} ¬∑ –∞–≤—Ç–æ—Ä: ${m.author}`;
      reasonList.innerHTML = "";

      for(const r of REPORT_REASONS){
        const el = document.createElement("div");
        el.className = "reason";
        el.innerHTML = `
          <div>
            <div class="l">${escapeHtml(r.label)}</div>
            <div class="r">${escapeHtml(r.hint)}</div>
          </div>
          <div style="color:var(--muted2); font-weight:950">‚Üí</div>
        `;
        el.addEventListener("click", ()=> sendReport(r.id));
        reasonList.appendChild(el);
      }

      openSheet(reportSheet);
    }

    function sendReport(reasonId){
      const memeId = state.report.openForMemeId;
      if(!memeId) return;

      const m = state.memes.find(x => x.id === memeId);
      if(m){
        m.reports = (m.reports || 0) + 1;
        state.hidden.add(m.id); // hide for this user
      }
      closeSheet(reportSheet);
      showToast("–ñ–∞–ª–æ–±–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞");

      // PROD: POST /report {meme_id, reason, reporter_id} -> backend -> admin chat
      console.log("[DEMO] Report:", { memeId, reason: reasonId, reporter: state.user.id });

      try{ TG?.HapticFeedback?.notificationOccurred?.("warning"); }catch(_){}
      nextMeme();
      if(document.getElementById("ratingScreen").classList.contains("on")) renderRating();
    }

    /*****************
     * Rating (fixed)
     *****************/
    const ratingScreen = document.getElementById("ratingScreen");
    const ratingList = document.getElementById("ratingList");

    document.getElementById("btnRating").addEventListener("click", ()=>{
      closeSheet(profileSheet);
      openRating();
    });
    document.getElementById("closeRating").addEventListener("click", closeRating);

    // mode tabs
    document.querySelectorAll("#modeTabs .tab").forEach(tab=>{
      tab.addEventListener("click", ()=>{
        document.querySelectorAll("#modeTabs .tab").forEach(t=>t.classList.remove("on"));
        tab.classList.add("on");
        state.rating.mode = tab.getAttribute("data-mode");
        renderRating();
      });
    });

    // range tabs
    document.querySelectorAll("#rangeTabs .tab").forEach(tab=>{
      tab.addEventListener("click", ()=>{
        document.querySelectorAll("#rangeTabs .tab").forEach(t=>t.classList.remove("on"));
        tab.classList.add("on");
        state.rating.range = tab.getAttribute("data-range");
        renderRating();
      });
    });

    function openRating(){
      ratingScreen.classList.add("on");
      ratingScreen.setAttribute("aria-hidden","false");
      renderRating();
    }
    function closeRating(){
      ratingScreen.classList.remove("on");
      ratingScreen.setAttribute("aria-hidden","true");
    }

    function renderRating(){
      ratingList.innerHTML = "";

      // NOTE: range is a UI filter placeholder. In prod you will request from backend:
      // GET /rating?mode=memes&range=week
      // Here we display same data for all ranges.

      if(state.rating.mode === "memes"){
        const items = [...state.memes].sort((a,b)=>{
          const sa = scoreOf(a), sb = scoreOf(b);
          if(sb !== sa) return sb - sa;
          return (b.likes||0) - (a.likes||0);
        }).slice(0, 30);

        items.forEach((m, idx)=>{
          const row = document.createElement("div");
          row.className = "row";
          row.innerHTML = `
            <div class="thumb"><img src="${escapeHtml(m.img)}" alt=""></div>
            <div class="info">
              <div class="main">#${idx+1} ¬∑ ${escapeHtml(m.title || m.id)}</div>
              <div class="sub">${escapeHtml(m.author)} ¬∑ üëç ${m.likes} ¬∑ üëé ${m.dislikes} ¬∑ —Ä–µ–ø–æ—Ä—Ç–æ–≤ ${m.reports||0}</div>
            </div>
            <div class="rank">${scoreOf(m)}<span class="s">score</span></div>
          `;
          ratingList.appendChild(row);
        });
      } else {
        const map = new Map();
        for(const m of state.memes){
          const a = map.get(m.authorId) || { authorId:m.authorId, author:m.author, likes:0, dislikes:0, score:0, memes:0 };
          a.likes += m.likes||0;
          a.dislikes += m.dislikes||0;
          a.score += scoreOf(m);
          a.memes += 1;
          map.set(m.authorId, a);
        }
        const authors = [...map.values()].sort((x,y)=>{
          if(y.score !== x.score) return y.score - x.score;
          return y.likes - x.likes;
        }).slice(0, 30);

        authors.forEach((a, idx)=>{
          const row = document.createElement("div");
          row.className = "row";
          row.innerHTML = `
            <div class="thumb">${escapeHtml(a.author[0]?.toUpperCase() || "U")}</div>
            <div class="info">
              <div class="main">#${idx+1} ¬∑ ${escapeHtml(a.author)}</div>
              <div class="sub">–º–µ–º–æ–≤ ${a.memes} ¬∑ üëç ${a.likes} ¬∑ üëé ${a.dislikes}</div>
            </div>
            <div class="rank">${a.score}<span class="s">score</span></div>
          `;
          ratingList.appendChild(row);
        });
      }
    }

    /*****************
     * Add meme (demo)
     *****************/
    const fileInput = document.getElementById("fileInput");
    document.getElementById("btnAddMeme").addEventListener("click", ()=>{
      closeSheet(profileSheet);
      addMemeFlow();
    });

    function addMemeFlow(){
      resetHourIfNeeded();
      const lvl = getLevelInfo(state.user.xp);

      if(state.user.postedToday >= lvl.perDay){
        showToast(`–õ–∏–º–∏—Ç –Ω–∞ —Å–µ–≥–æ–¥–Ω—è: ${lvl.perDay}.`);
        try{ TG?.HapticFeedback?.notificationOccurred?.("error"); }catch(_){}
        return;
      }
      if(state.user.postedThisHour >= lvl.perHour){
        showToast(`–õ–∏–º–∏—Ç –≤ —á–∞—Å: ${lvl.perHour}.`);
        try{ TG?.HapticFeedback?.notificationOccurred?.("error"); }catch(_){}
        return;
      }

      fileInput.value = "";
      fileInput.click();
    }

    fileInput.addEventListener("change", async ()=>{
      const file = fileInput.files?.[0];
      if(!file) return;

      const url = URL.createObjectURL(file);
      const title = prompt("–ü–æ–¥–ø–∏—Å—å –∫ –º–µ–º—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):", "–ù–æ–≤—ã–π –º–µ–º");
      const newId = "u1_" + Math.random().toString(16).slice(2,10);

      const m = {
        id: newId,
        authorId: state.user.id,
        author: state.user.name,
        title: (title || "–ù–æ–≤—ã–π –º–µ–º").slice(0, 80),
        img: url,
        likes: 0,
        dislikes: 0,
        reports: 0
      };

      state.memes.unshift(m);
      state.user.memesPosted++;
      state.user.postedToday++;
      state.user.postedThisHour++;

      // hide own meme from your feed (no self-like)
      state.seen.add(m.id);

      renderStats();
      showToast("–ú–µ–º –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω");

      rebuildQueue();
      if(!state.current) nextMeme();
      if(ratingScreen.classList.contains("on")) renderRating();
    });

    /*****************
     * Toast
     *****************/
    let toastTimer = null;
    function showToast(text){
      toast.textContent = text;
      toast.classList.add("on");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> toast.classList.remove("on"), 1400);
    }

    /*****************
     * Init user from Telegram
     *****************/
    function initUserFromTelegram(){
      try{
        const u = TG?.initDataUnsafe?.user;
        if(u){
          state.user.id = String(u.id);
          state.user.name = u.first_name || u.username || "User";
        }
      }catch(e){}
    }

    /*****************
     * Boot
     *****************/
    initUserFromTelegram();
    renderStats();
    rebuildQueue();
    nextMeme();

    // open profile via bubble click already; keep preview synced
    document.getElementById("profileBubble").addEventListener("click", ()=>{
      syncProfilePreview();
    });

    // ESC closes on desktop
    window.addEventListener("keydown", (e)=>{
      if(e.key === "Escape"){
        closeSheet(profileSheet);
        closeSheet(reportSheet);
        closeRating();
      }
    });
  </script>
</body>
</html>
